{% load comment_tags smart_if %}
<script type="text/javascript">function facebook_onlogin(){ window.location = "{% url auth.views.facebook_login_complete %}?next={{ object.get_absolute_url }}" }</script>

<form id="commentform" class="comments" action="{% comment_form_target %}" method="post">
  {% if user.is_authenticated %}
    <p><label for="id_comment">Comment:</label><br/>
    <textarea name="comment" id="id_comment"></textarea></p>
  {% else %}
    {% if request.session.user_name != None %}
      <p>Welcome back, <a href="{{ request.session.user_url }}" class="{{ request.session.user_type }}">
      	{{ request.session.user_name }}</a>!
      	(<a href="/auth/logout?next={{ object.get_absolute_url }}">Logout</a>)
      </p>
      <p><label for="id_comment">Comment:</label><br/>
      <textarea name="comment" id="id_comment"></textarea></p>
      <input type="hidden" name="name" value="{{ request.session.user_name }}"/>
      <input type="hidden" name="email" value="{{ request.session.user_email }}"/>
      <input type="hidden" name="url" value="{{ request.session.user_url }}"/>
      <input type="hidden" name="user_type" value="{{ request.session.user_type }}"/>
    {% else %}
      <div id="loginform">
	    <p>Or log in with your preferred identity:<br/>
           (no registration required)</p>
        <div>
          <img class="favicon" title="Google"
              src="{{ MEDIA_URL }}global/google.ico"/>
              <a href="/auth/google_login/?next={{ object.get_absolute_url }}">
              Sign in with Google Account</a><br/>
          <img class="favicon" title="OpenID" src="/auth/openid_logo" />
              <a href="/auth/openid_login/?next={{ object.get_absolute_url }}">
              Sign in with OpenID</a>
          <br/><br/>
          <fb:login-button onlogin="facebook_onlogin();"></fb:login-button>
        </div>
      </div>
      {% for field in form.visible_fields %}
      {{ field.errors }}
        <p {% if field.errors %}class="error"{% endif %}>
          {{ field.label_tag }}:<br/>{{ field }}
        </p>
      {% endfor %}
    {% endif %}
  {% endif %}
  
  {% for field in form.hidden_fields %}
    {% if field.name != 'auth_type' %}{{ field }}{% endif %}
  {% endfor %}
  
  <p class="submit">
    <input type="submit" name="post" class="submit-post" value="Submit" />
    <input type="hidden" name="next" value="{{ object.get_absolute_url }}#comments" />
  </p>
</form>